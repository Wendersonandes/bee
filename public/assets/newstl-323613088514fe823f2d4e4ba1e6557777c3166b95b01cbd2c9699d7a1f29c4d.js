var stopRotation=!1;window.addEventListener("load",function(){"use strict";function e(e,t,o){return(-(o.x*t.y*e.z)+t.x*o.y*e.z+o.x*e.y*t.z-e.x*o.y*t.z-t.x*e.y*o.z+e.x*t.y*o.z)/6}function t(){var e;try{var t="image/jpeg";e=a.domElement.toDataURL(t),i(e.replace(t,r),"test.jpg")}catch(e){return void console.log(e)}}$("#post_volume").hide();var o=640,n=550,a=new THREE.WebGLRenderer({preserveDrawingBuffer:!0}),r="image/octet-stream";$(document).on("click",".print-canvas",function(){var e=$(this).attr("id");console.log(e),"print-canvas-show"==e&&(stopRotation=!0,$("#print-canvas-show").hide(),$(".print-canvas-menu").show()),"print-canvas-back"==e&&(stopRotation=!1,$(".print-canvas-menu").hide(),$("#print-canvas-show").show()),"print-canvas-config"==e&&console.log("AEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE"),"print-canvas-get"==e&&t()});var i=function(e,t){var o=document.createElement("a");"string"==typeof o.download?(document.body.appendChild(o),o.download=t,o.href=e,o.click(),document.body.removeChild(o)):location.replace(uri)};if(document.getElementById("view_teste")){a.setSize(o,n);var s=document.getElementById("view_teste");s.appendChild(a.domElement);var E=new THREE.PerspectiveCamera(45,o/n,.1,2e4);E.position.set(0,0,150);var c=new THREE.OrbitControls(E,s),d=new THREE.Scene;d.add(new THREE.AmbientLight(6710886)),d.background=new THREE.Color(16777215);var l=new THREE.DirectionalLight(16777215);l.position.set(0,100,100),d.add(l);var v=new THREE.DirectionalLight(16777215);v.position.set(0,-100,-100),d.add(v);var m=new THREE.MeshPhongMaterial({color:12566463,ambient:12566463,specular:197379}),p=new THREE.Mesh(new THREE.Geometry,m);d.add(p);var g,y,u,w,z=new THREE.Mesh(new THREE.Geometry,m);(function e(){requestAnimationFrame(e),stopRotation||(z.rotation.y+=.002),c.update(),a.clear(),a.render(d,E)})();var f=function(t){var a=new FileReader;a.addEventListener("load",function(t){var a=t.target.result,r=loadStl(a);d.remove(z),p=new THREE.Mesh(r,m),p.rotation.x=-90*Math.PI/180;var i=(new THREE.Box3).setFromObject(p);console.log(i.min,i.max,i.size(),p.rotation),p.position.y=-(i.max.y-i.size().y/2),p.position.x=-(i.max.x-i.size().x/2),p.position.z=-(i.max.z-i.size().z/2),z=new THREE.Object3D,z.position.set(0,0,0),z.rotation.set(0,0,0),z.add(p),console.log("pqplsl");for(var l=0,v=0;v<p.geometry.faces.length;v++){console.log("blablabla");var f=p.geometry.faces[v].a,h=p.geometry.faces[v].b,R=p.geometry.faces[v].c;l+=e(new THREE.Vector3(p.geometry.vertices[f].x,p.geometry.vertices[f].y,p.geometry.vertices[f].z),new THREE.Vector3(p.geometry.vertices[h].x,p.geometry.vertices[h].y,p.geometry.vertices[h].z),new THREE.Vector3(p.geometry.vertices[R].x,p.geometry.vertices[R].y,p.geometry.vertices[R].z))}var T=Math.abs(l),x=i.size().x*i.size().y*i.size().z;console.log(x,T),$("#post_volume").val(T),g=i.size().x>i.size().y||i.size().z>i.size().y?i.size().z>i.size().y?i.size().z:i.size().x:i.size().y,y=2*Math.atan(g/400),console.log(y),u=y*(180/Math.PI),E=new THREE.PerspectiveCamera(u,o/n,1,800),E.position.set(0,63.767,300),w=12*(Math.PI/180),E.rotation.set(-w,0,0),c=new THREE.OrbitControls(E,s),d.add(z)},!1),a.readAsArrayBuffer(t)};document.getElementById("post_attachment").addEventListener("change",function(e){f(e.target.files[0])},!1),s.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"},!1),s.addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault(),f(e.dataTransfer.files[0])},!1)}},!1);