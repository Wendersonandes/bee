var stopRotation=!1;window.addEventListener("load",function(){"use strict";function e(e,t,o){return(-(o.x*t.y*e.z)+t.x*o.y*e.z+o.x*e.y*t.z-e.x*o.y*t.z-t.x*e.y*o.z+e.x*t.y*o.z)/6}function t(){var e;try{var t="image/jpeg";e=r.domElement.toDataURL(t),s(e.replace(t,a),"test.jpg")}catch(e){return void console.log(e)}}$("#post_volume").hide();var o=640,n=550,r=new THREE.WebGLRenderer({preserveDrawingBuffer:!0}),a="image/octet-stream";$(document).on("click",".print-canvas",function(){var e=$(this).attr("id");console.log(e),"print-canvas-show"==e&&(stopRotation=!0,$("#print-canvas-show").hide(),$(".print-canvas-menu").show()),"print-canvas-back"==e&&(stopRotation=!1,$(".print-canvas-menu").hide(),$("#print-canvas-show").show()),"print-canvas-config"==e&&console.log("AEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE"),"print-canvas-get"==e&&t()});var s=function(e,t){var o=document.createElement("a");"string"==typeof o.download?(document.body.appendChild(o),o.download=t,o.href=e,o.click(),document.body.removeChild(o)):location.replace(uri)};if(document.getElementById("view_teste")){r.setSize(o,n);var i=document.getElementById("view_teste");i.appendChild(r.domElement);var E=new THREE.PerspectiveCamera(45,o/n,.1,2e4);E.position.set(0,0,150);var c=new THREE.OrbitControls(E,i),v=new THREE.Scene;v.add(new THREE.AmbientLight(6710886)),v.background=new THREE.Color(16777215);var l=new THREE.DirectionalLight(16777215);l.position.set(0,100,100),v.add(l);var d=new THREE.DirectionalLight(16777215);d.position.set(0,-100,-100),v.add(d);var m=new THREE.MeshPhongMaterial({color:12566463,ambient:12566463,specular:197379}),g=new THREE.Mesh(new THREE.Geometry,m);v.add(g);var y,p,z,f,u=new THREE.Mesh(new THREE.Geometry,m);(function e(){requestAnimationFrame(e),stopRotation||(u.rotation.y+=.002),c.update(),r.clear(),r.render(v,E)})();var w=function(t){var r=new FileReader;r.addEventListener("load",function(t){var r=t.target.result,a=loadStl(r);v.remove(u),g=new THREE.Mesh(a,m),g.rotation.x=-90*Math.PI/180;var s=(new THREE.Box3).setFromObject(g);console.log(s.min,s.max,s.size(),g.rotation),g.position.y=-(s.max.y-s.size().y/2),g.position.x=-(s.max.x-s.size().x/2),g.position.z=-(s.max.z-s.size().z/2),u=new THREE.Object3D,u.position.set(0,0,0),u.rotation.set(0,0,0),u.add(g),console.log("pqplsl");for(var l=0,d=0;d<g.geometry.faces.length;d++){var w=g.geometry.faces[d].a,h=g.geometry.faces[d].b,R=g.geometry.faces[d].c;l+=e(new THREE.Vector3(g.geometry.vertices[w].x,g.geometry.vertices[w].y,g.geometry.vertices[w].z),new THREE.Vector3(g.geometry.vertices[h].x,g.geometry.vertices[h].y,g.geometry.vertices[h].z),new THREE.Vector3(g.geometry.vertices[R].x,g.geometry.vertices[R].y,g.geometry.vertices[R].z))}var x=Math.abs(l);$("#post_volume").val(x),$("#post_x").val(s.size().x),$("#post_y").val(s.size().y),$("#post_z").val(s.size().z);var T=g.geometry.faces.length,H=0;if(!T)return 0;for(var d=0;d<T;d++){var b=g.geometry.vertices[g.geometry.faces[d].a],L=g.geometry.vertices[g.geometry.faces[d].b],M=g.geometry.vertices[g.geometry.faces[d].c],A=L.clone().sub(b),P=M.clone().sub(b),B=new THREE.Vector3;B.crossVectors(A,P),H+=B.length()/2}var C=.8,_=.1,D=H*C/x,O=1.24*x*(D+(1-D)*_)/1e3;console.log("AREA:"+H),console.log("PESO:"+O),console.log("BOX: x:"+s.size().x+" y:"+s.size().y+" z:"+s.size().z);var I=2*s.size().x*s.size().y+2*s.size().z*s.size().y+2*s.size().x*s.size().z;console.log("AREA BOX:"+I),y=s.size().x>s.size().y||s.size().z>s.size().y?s.size().z>s.size().y?s.size().z:s.size().x:s.size().y,p=2*Math.atan(y/400),console.log(p),z=p*(180/Math.PI),E=new THREE.PerspectiveCamera(z,o/n,1,800),E.position.set(0,63.767,300),f=12*(Math.PI/180),E.rotation.set(-f,0,0),c=new THREE.OrbitControls(E,i),v.add(u)},!1),r.readAsArrayBuffer(t)};document.getElementById("post_attachment").addEventListener("change",function(e){w(e.target.files[0])},!1),i.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"},!1),i.addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault(),w(e.dataTransfer.files[0])},!1)}},!1);